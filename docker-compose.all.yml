# Run ALL examples with a single command:
#   docker compose -f docker-compose.all.yml up -d
#
# This starts the platform, deploys all BPMN processes, and runs
# a single unified worker container that handles all job types.

include:
  - docker-compose.yml

services:
  deploy:
    image: curlimages/curl:latest
    depends_on:
      zenbpm:
        condition: service_healthy
    volumes:
      - ./examples:/examples:ro
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        echo "Deploying all BPMN processes..."
        for f in /examples/processes/*/*.bpmn; do
          [ -f "$$f" ] || continue
          echo "  -> $$f"
          curl -sfS -X POST http://zenbpm:8080/v1/process-definitions -F "resource=@$$f"
          echo ""
        done
        echo "All processes deployed."

  workers:
    build:
      context: .
      dockerfile: utils/all-workers/Dockerfile
    environment:
      ZENBPM_GRPC_ADDR: zenbpm:9090
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
    depends_on:
      zenbpm:
        condition: service_healthy
