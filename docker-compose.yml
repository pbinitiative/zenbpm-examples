# Start everything:
#   docker compose up -d
#
# This starts the platform, deploys all BPMN processes, and runs the workers.

services:
  zenbpm:
    image: ghcr.io/pbinitiative/zenbpm:latest
    environment:
      - CONFIG_FILE=/var/zenbpm/zen-conf.yaml
    volumes:
      - ./conf/zenbpm/conf.yaml:/var/zenbpm/zen-conf.yaml
    ports:
      - "8080:8080"
      - "9090:9090"
    healthcheck:
      test: ["CMD-SHELL", "bash -c 'echo > /dev/tcp/localhost/8080'"]
      interval: 3s
      timeout: 3s
      retries: 10
      start_period: 10s

  zenbpm-ui:
    image: ghcr.io/pbinitiative/zenbpm-ui:demo_20260205_latest
    ports:
      - "9000:80"
    depends_on:
      zenbpm:
        condition: service_healthy

  deploy:
    image: curlimages/curl:latest
    depends_on:
      zenbpm:
        condition: service_healthy
    volumes:
      - ./examples:/examples:ro
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        echo "Deploying all BPMN processes..."
        for f in /examples/processes/*/*.bpmn; do
          [ -f "$$f" ] || continue
          echo "  -> $$f"
          curl -sfS -X POST http://zenbpm:8080/v1/process-definitions -F "resource=@$$f"
          echo ""
        done
        echo "All processes deployed."

  workers:
    build: ./examples/workers
    environment:
      ZENBPM_GRPC_ADDR: zenbpm:9090
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
    depends_on:
      zenbpm:
        condition: service_healthy
